<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets API POST í…ŒìŠ¤íŠ¸</title>
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter í°íŠ¸ ì‚¬ìš© */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
        .input-field {
            @apply w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-150 ease-in-out;
        }
    </style>
</head>
<body>
    <div class="max-w-3xl mx-auto p-6 bg-white shadow-2xl rounded-xl mt-10">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-6 border-b pb-2">
            API ë°ì´í„° ì „ì†¡ í…ŒìŠ¤íŠ¸ (Apps Script)
        </h1>
        <p class="text-gray-600 mb-6">
            í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ì…ë ¥í•˜ê³  ì œì¶œí•˜ì—¬ Google Sheetì— ì €ì¥ë˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
        </p>

        <!-- ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ -->
        <div id="message-box" class="p-4 rounded-lg text-sm mb-6 hidden" role="alert"></div>
        <div id="loading-indicator" class="hidden text-center p-4">
            <svg class="animate-spin h-5 w-5 mr-3 text-blue-500 inline-block" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            ë°ì´í„°ë¥¼ ì „ì†¡ ì¤‘ì…ë‹ˆë‹¤...
        </div>

        <form id="submission-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- UserID -->
            <div>
                <label for="UserID" class="block text-sm font-medium text-gray-700 mb-1">UserID (ì‚¬ìš©ì ID)</label>
                <input type="text" id="UserID" name="UserID" value="Tester_101" required class="input-field">
            </div>
            <!-- Title -->
            <div>
                <label for="Title" class="block text-sm font-medium text-gray-700 mb-1">Title (ê¸°ë¡ ì œëª©)</label>
                <input type="text" id="Title" name="Title" value="Apps Script ì—°ê²° í…ŒìŠ¤íŠ¸" required class="input-field">
            </div>
            <!-- department -->
            <div>
                <label for="department" class="block text-sm font-medium text-gray-700 mb-1">department (í•™ê³¼)</label>
                <input type="text" id="department" name="department" value="ë””ìì¸" class="input-field">
            </div>
            <!-- grade -->
            <div>
                <label for="grade" class="block text-sm font-medium text-gray-700 mb-1">grade (í•™ë…„)</label>
                <input type="text" id="grade" name="grade" value="3í•™ë…„" class="input-field">
            </div>
            <!-- book_title -->
            <div class="md:col-span-2">
                <label for="book_title" class="block text-sm font-medium text-gray-700 mb-1">book_title (ì±… ì œëª©)</label>
                <input type="text" id="book_title" name="book_title" value="ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„±ê³µ" required class="input-field">
            </div>
            <!-- book_author -->
            <div>
                <label for="book_author" class="block text-sm font-medium text-gray-700 mb-1">book_author (ì €ì)</label>
                <input type="text" id="book_author" name="book_author" value="êµ¬ê¸€ ê°œë°œì" class="input-field">
            </div>
            <!-- book_keywords -->
            <div>
                <label for="book_keywords" class="block text-sm font-medium text-gray-700 mb-1">book_keywords (ì£¼ í‚¤ì›Œë“œ)</label>
                <input type="text" id="book_keywords" name="book_keywords" value="API, í…ŒìŠ¤íŠ¸" class="input-field">
            </div>
            <!-- book_keywords_2 -->
            <div>
                <label for="book_keywords_2" class="block text-sm font-medium text-gray-700 mb-1">book_keywords_2 (ë³´ì¡° í‚¤ì›Œë“œ)</label>
                <input type="text" id="book_keywords_2" name="book_keywords_2" value="Google Sheets" class="input-field">
            </div>
            <!-- Keywords (ëŒ€ë¬¸ì K) -->
            <div>
                <label for="Keywords" class="block text-sm font-medium text-gray-700 mb-1">Keywords (ìµœì¢… í‚¤ì›Œë“œ)</label>
                <input type="text" id="Keywords" name="Keywords" value="ì„±ê³µ" class="input-field">
            </div>

            <!-- ì œì¶œ ë²„íŠ¼ -->
            <div class="md:col-span-2 mt-4">
                <button type="submit" id="submit-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-150 ease-in-out focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50">
                    ë°ì´í„° ì‹œíŠ¸ì— ì œì¶œ
                </button>
            </div>
        </form>
    </div>

    <script>
        // âœ… ì—¬ê¸°ì— ë°°í¬í•˜ì‹  ì›¹ ì•± URLì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
        const WEB_APP_URL = 'https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLh4_gxxDzgG1bCugehs2c2yb9uYGZA-69Vd1w0XORx8y2FSRbO6v0jRS7IYjgRqprtlXrn9xp9xFiuVctK7C3B12ZEcSwk8SUWglNnjq1NJiSnoEa8sbDsChx7RO-YLGMzPjU87GtddkeRrLiKrd1S2Yf59-_-vizSttHmsrr4sF0lwC6X2yDrHRgExNHXE_4ayoLg1VSRB-yEwuLe-BroT8SL99IPTpxf-dHReKjYeWe4qxMqzpxiD-t9mj6z6Wd4cm3Fr6rnG7yDrq1BYfXRIOkuzew&lib=MerK2E9-AkhCl36vftWFCnAySKxpBA-T6';

        const form = document.getElementById('submission-form');
        const messageBox = document.getElementById('message-box');
        const loadingIndicator = document.getElementById('loading-indicator');
        const submitButton = document.getElementById('submit-button');

        function showMessage(text, type = 'success') {
            messageBox.textContent = text;
            messageBox.className = 'p-4 rounded-lg text-sm mb-6';
            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-800');
            } else { // info
                messageBox.classList.add('bg-blue-100', 'text-blue-800');
            }
            messageBox.classList.remove('hidden');
        }

        function hideMessage() {
            messageBox.classList.add('hidden');
        }

        function toggleLoading(isLoading) {
            loadingIndicator.classList.toggle('hidden', !isLoading);
            submitButton.disabled = isLoading;
            submitButton.textContent = isLoading ? 'ì „ì†¡ ì¤‘...' : 'ë°ì´í„° ì‹œíŠ¸ì— ì œì¶œ';
        }

        // Exponential backoff with jitter
        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    // Handle rate limiting (429) or temporary server errors (5xx)
                    if (response.status === 429 || response.status >= 500) {
                        throw new Error(`Server error or rate limit: ${response.status}`);
                    }
                    // For other non-OK status codes, treat as permanent error
                    const errorText = await response.text();
                    throw new Error(`API Error (${response.status}): ${errorText.substring(0, 100)}...`);

                } catch (error) {
                    if (i === maxRetries - 1) {
                        // Throw error if it's the last attempt
                        throw error;
                    }

                    // Calculate delay with exponential backoff and jitter
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }


        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage();
            toggleLoading(true);

            const formData = new FormData(form);
            const data = {};
            
            // í¼ ë°ì´í„°ë¥¼ JSON ê°ì²´ë¡œ ë³€í™˜
            formData.forEach((value, key) => {
                data[key] = value;
            });
            
            // Apps Scriptì—ì„œ ìš”êµ¬í•˜ëŠ” JSON í˜•ì‹ì— ë§ì¶° 'postData'ì˜ contentsë¡œ ì „ì†¡
            const postOptions = {
                method: 'POST',
                // Apps ScriptëŠ” 'application/json'ì„ ëª…ì‹œì ìœ¼ë¡œ ìš”êµ¬í•˜ì§€ ì•Šìœ¼ë©°, 
                // bodyë¥¼ textë¡œ íŒŒì‹±í•˜ê³  JSON.parse(e.postData.contents)ë¡œ ì²˜ë¦¬í•¨.
                // ë”°ë¼ì„œ Content-Typeì„ ìƒëµí•˜ê±°ë‚˜ 'application/x-www-form-urlencoded'ì²˜ëŸ¼ ë™ì‘í•˜ê²Œ 
                // bodyì— JSON.stringify(data)ë¥¼ ë„£ëŠ” ê²ƒì´ ê°€ì¥ ì•ˆì •ì ì…ë‹ˆë‹¤.
                body: JSON.stringify(data), 
            };

            try {
                // Fetch ìš”ì²­ ì‹¤í–‰
                const response = await fetchWithRetry(WEB_APP_URL, postOptions);
                const result = await response.json();
                
                if (result.status === 'SUCCESS') {
                    showMessage(`âœ… ì„±ê³µ: ë°ì´í„°ê°€ Google Sheetì— ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. (ë©”ì‹œì§€: ${result.message})`, 'success');
                    // ì„ íƒì ìœ¼ë¡œ í¼ ì´ˆê¸°í™”
                    // form.reset(); 
                } else {
                    showMessage(`âŒ ì‹¤íŒ¨: API ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ì˜¤ë¥˜ ë©”ì‹œì§€: ${result.message})`, 'error');
                }

            } catch (error) {
                console.error("Fetch Error:", error);
                showMessage(`âŒ ì „ì†¡ ì‹¤íŒ¨: ì„œë²„ ì—°ê²° ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜. ìì„¸í•œ ë‚´ìš©ì€ ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”. (ì˜¤ë¥˜: ${error.message})`, 'error');
            } finally {
                toggleLoading(false);
            }
        });

        // ì´ˆê¸° ìƒíƒœ ë©”ì‹œì§€ (API URLì´ ì„¤ì •ë˜ì—ˆìŒì„ ì•ˆë‚´)
        document.addEventListener('DOMContentLoaded', () => {
             showMessage("ğŸ“Œ ì´ í˜ì´ì§€ëŠ” í…ŒìŠ¤íŠ¸ìš©ì´ë©°, Apps Script ì›¹ ì•± URLì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ë°ì´í„°ë¥¼ ì…ë ¥í•˜ê³  'ì œì¶œ'í•´ ë³´ì„¸ìš”.", 'info');
        });
    </script>
</body>
</html>